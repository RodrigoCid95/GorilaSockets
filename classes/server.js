"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SocketsServer=void 0;var tslib_1=require("tslib"),SocketIo=require("socket.io"),gorila_core_1=require("gorila-core"),SocketsServer=function(){function o(o,e,t,s){this.httpServer=o,this.loaderConfig=e,this.SocketsControllersDeclarations=t,this.lm=s,this.SocketsControllersInstances=[],this.routes=[]}return o.prototype.init=function(){var o;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this.useLogger=null===(o=this.socketsConfig)||void 0===o?void 0:o.useLogger,gorila_core_1.Log("Iniciando Sockets Server...",this.useLogger),!this.lm||this.lm.isCompiled()?[3,2]:[4,this.lm.build()];case 1:e.sent(),e.label=2;case 2:return[4,this.runSocketsServer()];case 3:return e.sent(),[2]}}))}))},o.prototype.runSocketsServer=function(){var o;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,s,n,i,r=this;return tslib_1.__generator(this,(function(c){for(gorila_core_1.Log("Preparando servidor ...",this.useLogger),gorila_core_1.Log("Cargando controlladores ...",this.useLogger),e=0,t=this.SocketsControllersDeclarations;e<t.length;e++)s=t[e],n=new s(this.useLogger,this.lm),this.SocketsControllersInstances.push(n),this.routes=this.routes.concat(n.routes);return gorila_core_1.Log("Controladores cargados!",this.useLogger),gorila_core_1.Log("Aplicando configuraciÃ³n ...",this.useLogger),this.socketsConfig=this.loaderConfig.getConfig("GorilaSockets"),this.port=(null===(o=this.socketsConfig)||void 0===o?void 0:o.port)||5e3,i=this.httpServer||this.port,this.io=new SocketIo(i,this.socketsConfig),this.io.on("connect",(function(o){var e,t;(null===(t=null===(e=r.socketsConfig)||void 0===e?void 0:e.events)||void 0===t?void 0:t.onConnect)&&r.socketsConfig.events.onConnect(o);for(var s=function(e,t){o.on(e,(function(){for(var e,s,n,i,c,l,v=[],u=0;u<arguments.length;u++)v[u]=arguments[u];var a=v.find((function(o){return"function"==typeof o})),g=v.filter((function(o){return"function"!=typeof o}));try{(null===(s=null===(e=r.socketsConfig)||void 0===e?void 0:e.events)||void 0===s?void 0:s.onANewRequest)&&(g=r.socketsConfig.events.onANewRequest(g,o,null==r?void 0:r.lm.getLibrary.bind(r.lm)));var d=t.apply(void 0,g);d instanceof Promise?d.then((function(e){var t,s;e=(null===(s=null===(t=r.socketsConfig)||void 0===t?void 0:t.events)||void 0===s?void 0:s.onBeforeToAnswer)?r.socketsConfig.events.onBeforeToAnswer(e,o,r.lm.getLibrary.bind(r.lm)):e,a&&(e?a(e):a())})).catch((function(o){throw{error:!0,level:null!=o.code?1:0,code:null!=o.code?o.code:0,message:null!=o.message?o.message:o}})):(d=(null===(i=null===(n=r.socketsConfig)||void 0===n?void 0:n.events)||void 0===i?void 0:i.onBeforeToAnswer)?r.socketsConfig.events.onBeforeToAnswer(d,o,r.lm.getLibrary.bind(r.lm)):d,a&&a(d))}catch(e){e={error:!0,level:0,code:void 0!==e.code?e.code:0,message:void 0!==e.message?e.message:e,stack:e.stack},e=(null===(l=null===(c=r.socketsConfig)||void 0===c?void 0:c.events)||void 0===l?void 0:l.onBeforeToAnswer)?r.socketsConfig.events.onBeforeToAnswer(e,o,r.lm.getLibrary.bind(r.lm)):e,a&&a(e)}}))},n=0,i=r.routes;n<i.length;n++){var c=i[n];s(c.path,c.callback)}o.on("disconnect",(function(e){var t,s;(null===(s=null===(t=r.socketsConfig)||void 0===t?void 0:t.events)||void 0===s?void 0:s.onDisconnect)&&r.socketsConfig.events.onDisconnect(e,o)}))})),gorila_core_1.Log("Servidor listo!",this.useLogger),[2]}))}))},o}();exports.SocketsServer=SocketsServer;